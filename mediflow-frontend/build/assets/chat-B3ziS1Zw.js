import{j as e}from"./vendor-ui-U3Ba6Q2R.js";import{a as s,d as a}from"./vendor-react-BE6zuAE5.js";import{p as t,t as r,y as l,C as n,r as i,B as c,A as o,n as d,s as m,m as x,v as h,I as u,z as g,g as f,q as j,D as b,i as v,j as N,k as p,l as y}from"./dashboard-Bz_aPqVj.js";import{l as w}from"./vendor-socket-Ba10ZAmw.js";import{P as S,V as C,G as _,L as k,I as D,J as U,B as L,K as I}from"./vendor-icons-MnWTdEGO.js";const M=s.createContext(void 0),z=()=>{const e=s.useContext(M);if(!e)throw new Error("useSocket must be used within a SocketProvider");return e},E=({children:a})=>{const[l,n]=s.useState(null),[i,c]=s.useState([]),[o,d]=s.useState(!1),{user:m}=t();s.useEffect(()=>{const e=localStorage.getItem("token");if(e&&m){const s=w("http://localhost:8000",{auth:{token:e}});return s.on("connect",()=>{d(!0),r.success("Connected to chat server")}),s.on("disconnect",()=>{d(!1),r.error("Disconnected from chat server")}),s.on("online_users",e=>{c(e)}),s.on("connect_error",e=>{r.error("Failed to connect to chat server")}),n(s),()=>{s.disconnect()}}l&&(l.disconnect(),n(null),d(!1))},[m]);const x=s.useCallback((e,s)=>{l&&l.emit("send_message",{receiverId:e,content:s})},[l]),h=s.useCallback(e=>{l&&l.emit("typing",{receiverId:e})},[l]),u=s.useCallback(e=>{l&&l.emit("stop_typing",{receiverId:e})},[l]),g=s.useCallback(e=>{l&&l.on("notification_received",e)},[l]),f=s.useCallback(e=>{l&&l.off("notification_received",e)},[l]);return e.jsx(M.Provider,{value:{socket:l,onlineUsers:i,isConnected:o,sendMessage:x,emitTyping:h,emitStopTyping:u,onNotification:g,offNotification:f},children:a})},T=({user:a,onBack:g})=>{const{user:f}=t(),{socket:j}=z(),[b,v]=s.useState([]),[N,p]=s.useState(""),[y,w]=s.useState(!0),[U,L]=s.useState(!1),I=s.useRef(null);s.useEffect(()=>{a?._id&&E()},[a?._id]),s.useEffect(()=>{if(!j)return;const e=e=>{const s="object"==typeof e.senderId?e.senderId._id:e.senderId,t="object"==typeof e.receiverId?e.receiverId._id:e.receiverId;(s===a._id&&t===f?._id||s===f?._id&&t===a._id)&&(v(s=>s.some(s=>s._id===e._id)?s:[...s,e]),M())};return j.on("newMessage",e),()=>{j.off("newMessage",e)}},[j,a?._id,f?._id]),s.useEffect(()=>{M()},[b]);const M=()=>{I.current?.scrollIntoView({behavior:"smooth"})},E=async()=>{try{w(!0);const s=await(e=a._id,l.get(`/api/messages/conversation/${e}`));v(s.data.data||[])}catch(s){r.error("Failed to load messages")}finally{w(!1)}var e},T=e=>{const s=new Date(e),a=new Date,t=new Date(a);return t.setDate(t.getDate()-1),s.toDateString()===a.toDateString()?s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):s.toDateString()===t.toDateString()?"Yesterday "+s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):s.toLocaleDateString("en-US",{month:"short",day:"numeric"})+" "+s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"})};return e.jsxs(n,{className:"flex-1 flex flex-col overflow-hidden",children:[e.jsx(i,{className:"bg-gradient-to-r from-emerald-50 to-teal-50 border-b flex-shrink-0 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[g&&e.jsx(c,{variant:"ghost",size:"sm",onClick:g,className:"md:hidden",children:"←"}),e.jsx(o,{className:"h-12 w-12 border-2 border-emerald-500",children:e.jsx(d,{className:"bg-emerald-100 text-emerald-700 font-semibold",children:a?.name?.split(" ").map(e=>e[0]).join("")||"U"})}),e.jsxs("div",{children:[e.jsx(m,{className:"text-lg text-emerald-900",children:a?.name||"Unknown User"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(x,{className:(e=>{switch(e?.toLowerCase()){case"doctor":return"bg-green-100 text-green-800";case"patient":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}})(a?.role),children:a?.role||"User"}),a?.specialization&&e.jsx("span",{className:"text-xs text-gray-600",children:a.specialization})]})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(c,{variant:"ghost",size:"sm",className:"text-emerald-600 hover:bg-emerald-100",children:e.jsx(S,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"text-emerald-600 hover:bg-emerald-100",children:e.jsx(C,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"sm",className:"text-emerald-600 hover:bg-emerald-100",children:e.jsx(_,{className:"h-4 w-4"})})]})]})}),e.jsx(h,{className:"flex-1 overflow-y-scroll p-4 bg-gray-50",style:{maxHeight:"480px",overflow:"scroll"},children:y?e.jsx("div",{className:"flex items-center justify-center h-full",children:e.jsx(k,{className:"h-8 w-8 animate-spin text-emerald-600"})}):0===b.length?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center",children:[e.jsx("div",{className:"bg-emerald-100 p-4 rounded-full mb-4",children:e.jsx(D,{className:"h-8 w-8 text-emerald-600"})}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:"No messages yet"}),e.jsx("p",{className:"text-gray-600 mt-2",children:"Start the conversation by sending a message below"})]}):e.jsxs("div",{className:"space-y-4",children:[b.map((s,a)=>{const t=s.senderId===f?._id||s.senderId?._id===f?._id;return e.jsx("div",{className:"flex "+(t?"justify-end":"justify-start"),children:e.jsxs("div",{className:"flex items-end space-x-2 max-w-[70%] "+(t?"flex-row-reverse space-x-reverse":""),children:[!t&&e.jsx(o,{className:"h-8 w-8 border border-gray-300",children:e.jsx(d,{className:"bg-gray-200 text-gray-700 text-xs",children:s.senderId?.name?.split(" ").map(e=>e[0]).join("")||"U"})}),e.jsxs("div",{children:[e.jsx("div",{className:"rounded-2xl px-4 py-2 "+(t?"bg-emerald-600 text-gray-300 rounded-br-none":"bg-white border border-gray-200 text-gray-900 rounded-bl-none"),children:e.jsx("p",{className:"text-sm break-words",children:s.content})}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1 px-1 "+(t?"justify-end":""),children:[e.jsx("span",{className:"text-xs text-gray-500",children:T(s.createdAt)}),t&&e.jsx("span",{className:"text-xs text-gray-500",children:s.isRead?"✓✓":"✓"})]})]})]})},`${s._id}-${a}`)}),e.jsx("div",{ref:I})]})}),e.jsx("div",{className:"border-t bg-white p-4 flex-shrink-0",children:e.jsxs("form",{onSubmit:async e=>{if(e.preventDefault(),!N.trim())return;const s=N.trim();p("");try{L(!0);const e=await(t={receiverId:a._id,content:s},l.post("/api/messages",t)),r=e.data.data||e.data;r&&(v(e=>[...e,r]),setTimeout(()=>M(),100))}catch(n){r.error("Failed to send message"),p(s)}finally{L(!1)}var t},className:"flex items-center space-x-2",children:[e.jsx(u,{value:N,onChange:e=>p(e.target.value),placeholder:"Type your message...",disabled:U,className:"flex-1 border-emerald-200 focus:border-emerald-500"}),e.jsx(c,{type:"submit",disabled:U||!N.trim(),className:"bg-emerald-600 hover:bg-emerald-700",children:U?e.jsx(k,{className:"h-4 w-4 animate-spin"}):e.jsx(D,{className:"h-4 w-4"})})]})})]})},A=({conversations:s,selectedUser:t,onSelectUser:r,onNewChat:l,loading:g=!1})=>{const[f,j]=a.useState(""),b=s.filter(e=>e.user?.name?.toLowerCase().includes(f.toLowerCase())),v=e=>{const s=new Date(e),a=new Date,t=new Date(a);return t.setDate(t.getDate()-1),s.toDateString()===a.toDateString()?s.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit"}):s.toDateString()===t.toDateString()?"Yesterday":s.toLocaleDateString("en-US",{month:"short",day:"numeric"})},N=(e,s=40)=>e.length<=s?e:e.substring(0,s)+"...";return e.jsxs(n,{className:"h-full flex flex-col",children:[e.jsxs(i,{className:"bg-gradient-to-r from-emerald-50 to-teal-50 border-b",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(m,{className:"flex items-center text-emerald-900",children:[e.jsx(U,{className:"h-5 w-5 mr-2"}),"Messages"]}),l&&e.jsx(c,{size:"sm",variant:"ghost",onClick:l,className:"text-emerald-600 hover:bg-emerald-100",children:e.jsx(L,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"mt-4 relative",children:[e.jsx(I,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(u,{placeholder:"Search conversations...",value:f,onChange:e=>j(e.target.value),className:"pl-10 border-emerald-200 focus:border-emerald-500"})]})]}),e.jsx(h,{className:"flex-1 overflow-y-auto p-0",children:g?e.jsx("div",{className:"flex items-center justify-center h-32",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"})}):0===b.length?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-6 text-center",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-full mb-4",children:e.jsx(U,{className:"h-8 w-8 text-gray-400"})}),e.jsx("h3",{className:"font-semibold text-gray-900",children:"No conversations"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:f?"No conversations match your search":"Start a new chat to begin messaging"})]}):e.jsx("div",{className:"divide-y divide-gray-100",children:b.map(s=>{const a=t?._id===s.user?._id,l=s.lastMessage,n=s.unreadCount||0;return e.jsx("div",{onClick:()=>r(s.user),className:"p-4 cursor-pointer transition-colors hover:bg-emerald-50 "+(a?"bg-emerald-50 border-l-4 border-emerald-600":""),children:e.jsxs("div",{className:"flex items-start space-x-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(o,{className:"h-12 w-12 "+(a?"border-2 border-emerald-600":"border border-gray-300"),children:e.jsx(d,{className:a?"bg-emerald-100 text-emerald-700":"bg-gray-100 text-gray-700",children:s.user?.name?.split(" ").map(e=>e[0]).join("")||"U"})}),n>0&&e.jsx("div",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-semibold",children:n>9?"9+":n})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold truncate "+(n>0?"text-gray-900":"text-gray-800"),children:s.user?.name||"Unknown User"}),e.jsx("div",{className:"flex items-center space-x-2 mt-1",children:e.jsx(x,{variant:"secondary",className:"text-xs "+("doctor"===s.user?.role?.toLowerCase()?"bg-green-100 text-green-800":"bg-blue-100 text-blue-800"),children:s.user?.role||"User"})})]}),l&&e.jsx("span",{className:"text-xs text-gray-500 ml-2 whitespace-nowrap",children:v(l.createdAt)})]}),l&&e.jsx("p",{className:"text-sm mt-1 truncate "+(n>0?"font-medium text-gray-900":"text-gray-600"),children:N(l.content)})]})]})},s.user?._id)})})})]})},B=({open:a,onClose:l,onSelectUser:n})=>{const{user:i}=t(),[c,m]=s.useState(""),[h,w]=s.useState([]),[S,C]=s.useState(!1);s.useEffect(()=>{a&&_()},[a]);const _=async()=>{try{let s;if(C(!0),"doctor"===i?.role?.toLowerCase())s=await g(),w(s.data.data||[]);else if("patient"===i?.role?.toLowerCase())try{s=await f();const e=Array.isArray(s.data)?s.data:[];w(e)}catch(e){const s=(await j()).data||[],a=new Map;s.forEach(e=>{const s=e.doctorId;s&&"object"==typeof s&&s._id&&a.set(s._id,s)}),w(Array.from(a.values()))}}catch(e){r.error("Failed to load users. You may need appointments with doctors first."),w([])}finally{C(!1)}},D=h.filter(e=>e.name?.toLowerCase().includes(c.toLowerCase()));return e.jsx(b,{open:a,onOpenChange:l,children:e.jsxs(v,{className:"sm:max-w-md",children:[e.jsxs(N,{children:[e.jsxs(p,{className:"flex items-center text-emerald-900",children:[e.jsx(U,{className:"h-5 w-5 mr-2"}),"Start New Conversation"]}),e.jsxs(y,{children:["Search for ","doctor"===i?.role?.toLowerCase()?"patients":"doctors"," to start chatting"]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(I,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(u,{placeholder:"Search by name...",value:c,onChange:e=>m(e.target.value),className:"pl-10 border-emerald-200 focus:border-emerald-500"})]}),e.jsx("div",{className:"max-h-96 overflow-y-auto",children:S?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(k,{className:"h-8 w-8 animate-spin text-emerald-600"})}):0===D.length?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("div",{className:"bg-gray-100 p-4 rounded-full inline-block mb-4",children:e.jsx(I,{className:"h-8 w-8 text-gray-400"})}),e.jsx("p",{className:"text-gray-600",children:c?"No users found matching your search":"No users available"})]}):e.jsx("div",{className:"space-y-2",children:D.map(s=>e.jsxs("div",{onClick:()=>(e=>{n(e),l(),m("")})(s),className:"flex items-center space-x-3 p-3 rounded-lg hover:bg-emerald-50 cursor-pointer transition-colors border border-transparent hover:border-emerald-200",children:[e.jsx(o,{className:"h-12 w-12 border border-gray-300",children:e.jsx(d,{className:"bg-emerald-100 text-emerald-700",children:s.name?.split(" ").map(e=>e[0]).join("")||"U"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"font-semibold text-gray-900 truncate",children:s.name}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[e.jsx(x,{variant:"secondary",className:"text-xs "+("doctor"===s.role?.toLowerCase()?"bg-green-100 text-green-800":"bg-blue-100 text-blue-800"),children:s.role}),s.specialization&&e.jsx("span",{className:"text-xs text-gray-600",children:s.specialization})]}),s.email&&e.jsx("p",{className:"text-xs text-gray-500 mt-1 truncate",children:s.email})]}),e.jsx(U,{className:"h-5 w-5 text-emerald-600"})]},s._id))})})]})})},F=Object.freeze(Object.defineProperty({__proto__:null,ChatManager:()=>{const{socket:a}=z(),[t,n]=s.useState([]),[i,c]=s.useState(null),[o,d]=s.useState(!1),[m,x]=s.useState(!0),[h,u]=s.useState(!1);s.useEffect(()=>{g()},[]),s.useEffect(()=>{if(!a)return;const e=e=>{g()};return a.on("newMessage",e),()=>{a.off("newMessage",e)}},[a]);const g=async()=>{try{x(!0);const e=await l.get("/api/messages/conversations");n(e.data.data||[])}catch(e){r.error("Failed to load conversations")}finally{x(!1)}};return e.jsxs("div",{className:"h-full flex flex-col",children:[e.jsxs("div",{className:"bg-gradient-to-r from-emerald-50 to-teal-50 border-b p-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-emerald-900",children:"Messages"}),e.jsx("p",{className:"text-sm text-gray-600",children:"Chat with your healthcare team"})]}),e.jsxs("div",{className:"flex-1 grid grid-cols-1 md:grid-cols-3 gap-0 overflow-hidden",children:[e.jsx("div",{className:"md:col-span-1 h-full border-r "+(h?"hidden md:block":"block"),children:e.jsx(A,{conversations:t,selectedUser:i,onSelectUser:e=>{c(e),u(!0)},onNewChat:()=>d(!0),loading:m})}),e.jsx("div",{className:`md:col-span-2 h-full ${h||i?"flex":"hidden md:flex"} flex-col`,children:i?e.jsx(T,{user:i,onBack:()=>{u(!1)}}):e.jsxs("div",{className:"hidden md:flex flex-col items-center justify-center h-full bg-gray-50",children:[e.jsx("div",{className:"bg-emerald-100 p-6 rounded-full mb-4",children:e.jsx("svg",{className:"h-16 w-16 text-emerald-600",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"})})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-gray-600 text-center max-w-sm",children:"Choose a conversation from the list or start a new chat to begin messaging"})]})})]}),e.jsx(B,{open:o,onClose:()=>d(!1),onSelectUser:e=>{c(e),d(!1),u(!0)}})]})}},Symbol.toStringTag,{value:"Module"}));export{F as C,E as S,z as u};
